<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 학습 도우미</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center font-sans p-4 sm:p-6">

    <!-- Main Container -->
    <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-2xl flex flex-col min-h-[90vh]">
        
        <!-- Header -->
        <div class="mb-6 text-center">
            <h1 class="text-3xl font-bold text-gray-800">AI 학습 도우미</h1>
            <p class="text-gray-500 mt-1">궁금한 점에 대해 AI가 답해 드립니다.</p>
            <p id="user-id-display" class="text-xs text-gray-400 mt-2"></p>
        </div>

        <!-- Chat Container -->
        <div id="chat-container" class="flex-grow overflow-y-auto space-y-4 p-4 bg-gray-50 rounded-2xl mb-4 shadow-inner">
            <!-- Messages will be injected here -->
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden text-red-500 text-center mb-4"></div>

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="hidden text-center mb-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto"></div>
            <p class="text-gray-500 mt-2">답변 생성 중...</p>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex justify-center space-x-2 mb-4">
            <button id="summarize-button" class="hidden bg-purple-500 text-white p-3 rounded-full shadow-lg hover:bg-purple-600 transition-colors duration-200">
                <span class="font-semibold">✨ 마지막 답변 요약하기</span>
            </button>
        </div>

        <!-- Input Area -->
        <div class="flex items-center space-x-3">
            <input type="text" id="question-input" placeholder="여기에 질문을 입력하세요..." class="flex-grow p-4 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200 shadow-sm">
            <button id="submit-button" class="bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 transition-colors duration-200 transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                </svg>
            </button>
        </div>

    </div>

    <!-- API Key Modal -->
    <div id="api-key-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl p-8 shadow-2xl max-w-md w-full">
            <h2 class="text-2xl font-bold mb-4 text-center">API 키 입력</h2>
            <p class="text-gray-600 mb-6 text-center">OpenAI API 키를 입력하면 대화를 시작할 수 있습니다. 입력된 키는 안전하게 저장됩니다.</p>
            <input type="text" id="api-key-input" placeholder="여기에 API 키를 입력하세요..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
            <button id="save-key-button" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition-colors duration-200">키 저장하기</button>
            <p id="modal-error-message" class="text-red-500 text-center mt-4 hidden"></p>
        </div>
    </div>
    
    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Log levels for debugging
        setLogLevel('debug');
        
        // Firebase global variables (DO NOT CHANGE)
        let app = null;
        let auth = null;
        let db = null;
        let userId = null;
        let OPENAI_API_KEY = null;
        let currentApi = 'openai';

        // Initialize Firebase and Auth
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (Object.keys(firebaseConfig).length) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } else {
            console.error("Firebase config is missing.");
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                initApp();
            } else {
                console.log("No user is signed in. Signing in anonymously...");
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    document.getElementById('modal-error-message').textContent = '인증 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.';
                    document.getElementById('modal-error-message').classList.remove('hidden');
                }
            }
        });
        
        // Get API Key from Firestore
        async function getApiKey() {
            if (!db || !userId) return null;
            
            try {
                const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/private_settings`, "api_keys");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data().openai_api_key;
                } else {
                    console.log("No API key found in Firestore.");
                    return null;
                }
            } catch (e) {
                console.error("Error getting API key from Firestore:", e);
                return null;
            }
        }

        // Save API Key to Firestore
        async function saveApiKey(key) {
            if (!db || !userId) return false;
            
            try {
                const docRef = doc(db, `artifacts/${__app_id}/users/${userId}/private_settings`, "api_keys");
                await setDoc(docRef, { openai_api_key: key });
                return true;
            } catch (e) {
                console.error("Error saving API key to Firestore:", e);
                return false;
            }
        }
        
        // Chat history storage
        let chatHistoryCollection = null;
        let chatHistory = [];
        
        // Initialize app functions after auth
        function initApp() {
            const userIdDisplay = document.getElementById('user-id-display');
            if (userIdDisplay) {
                 userIdDisplay.textContent = `User ID: ${userId}`;
            }
           
            // Set up Firestore collection reference for chat history
            chatHistoryCollection = collection(db, `artifacts/${__app_id}/users/${userId}/chat_history`);
            
            // Listen for real-time updates to chat history
            onSnapshot(chatHistoryCollection, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added") {
                        const newMsg = change.doc.data();
                        chatHistory.push(newMsg);
                        addMessageToUI(newMsg.content, newMsg.sender);
                    }
                });
            });
            
            // Show modal if API key is not set
            getApiKey().then(key => {
                if (key) {
                    OPENAI_API_KEY = key;
                    hideModal();
                    addMessageToUI("API 키가 저장되었습니다. 무엇을 도와드릴까요?", 'ai');
                } else {
                    showModal();
                }
            });
        }
        
        // UI logic
        const apiKeyModal = document.getElementById('api-key-modal');
        const apiKeyInput = document.getElementById('api-key-input');
        const saveKeyButton = document.getElementById('save-key-button');
        const chatContainer = document.getElementById('chat-container');
        const questionInput = document.getElementById('question-input');
        const submitButton = document.getElementById('submit-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessage = document.getElementById('error-message');
        const summarizeButton = document.getElementById('summarize-button');
        
        function showModal() {
            if (apiKeyModal) {
                 apiKeyModal.classList.remove('hidden');
                 document.body.classList.add('overflow-hidden');
            }
        }
        
        function hideModal() {
            if (apiKeyModal) {
                apiKeyModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }
        }
        
        function addMessageToUI(content, sender, isSummary = false) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('flex', 'p-2', 'rounded-xl');
            
            if (sender === 'user') {
                messageElement.classList.add('justify-end');
                messageElement.innerHTML = `<div class="bg-blue-500 text-white p-3 rounded-xl max-w-[85%] message-container"><p>${content}</p></div>`;
            } else {
                messageElement.classList.add('justify-start');
                messageElement.innerHTML = `<div class="bg-gray-200 text-gray-800 p-3 rounded-xl max-w-[85%] message-container"><p>${content}</p></div>`;
            }
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            if (sender === 'ai' && !isSummary) {
                lastAiResponse = content;
                summarizeButton.classList.remove('hidden');
            } else {
                summarizeButton.classList.add('hidden');
            }
        }
        
        // API Configuration
        const apiConfigs = {
            openai: {
                model: "gpt-4o-mini",
                textUrl: "https://api.openai.com/v1/chat/completions"
            }
        };

        let lastAiResponse = "";
        
        async function getApiResponse(prompt, systemInstruction = null) {
            const config = apiConfigs[currentApi];
            let retryCount = 0;
            const maxRetries = 3;
            const baseDelay = 1000;

            if (!OPENAI_API_KEY) {
                errorMessage.textContent = 'API 키가 설정되지 않았습니다. API 키를 먼저 입력해 주세요.';
                errorMessage.classList.remove('hidden');
                return null;
            }

            while (retryCount < maxRetries) {
                try {
                    let messages = [{ role: "user", content: prompt }];
                    if (systemInstruction) {
                        messages.unshift({ role: "system", content: systemInstruction });
                    }

                    const payload = {
                        model: config.model,
                        messages: messages
                    };
                    
                    const response = await fetch(config.textUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${OPENAI_API_KEY}`
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        let errorDetail = `Status: ${response.status} ${response.statusText}`;
                        if (response.status === 401) {
                            errorDetail = 'API 키가 유효하지 않습니다. 새로운 키를 발급받아 다시 시도해 주세요.';
                            OPENAI_API_KEY = null;
                            showModal();
                        } else if (response.status === 403) {
                             errorDetail = 'API 키에 이 모델에 접근할 수 있는 권한이 없습니다.';
                        } else if (response.status === 429) {
                            const delay = baseDelay * Math.pow(2, retryCount);
                            console.log(`Rate limit exceeded. Retrying in ${delay}ms...`);
                            await new Promise(res => setTimeout(res, delay));
                            retryCount++;
                            continue;
                        }
                        const errorResponseText = await response.text();
                        console.error("API error response:", errorResponseText);
                        throw new Error(`API error: ${errorDetail}`);
                    }

                    const result = await response.json();
                    const text = result?.choices?.[0]?.message?.content;
                    
                    if (text) {
                        return text;
                    } else {
                        throw new Error("API response did not contain expected text.");
                    }
                } catch (error) {
                    console.error("Failed to fetch from API:", error);
                    throw error;
                }
            }
            throw new Error("Failed to fetch from API after multiple retries.");
        }

        async function sendMessage() {
            const question = questionInput.value.trim();
            if (question === '') {
                return;
            }

            addMessageToUI(question, 'user');
            await addDoc(chatHistoryCollection, {
                sender: 'user',
                content: question,
                timestamp: Date.now()
            });
            questionInput.value = '';
            
            loadingSpinner.classList.remove('hidden');
            submitButton.disabled = true;
            questionInput.disabled = true;
            summarizeButton.classList.add('hidden');
            errorMessage.classList.add('hidden');

            try {
                const aiResponseText = await getApiResponse(question);
                if (aiResponseText) {
                     await addDoc(chatHistoryCollection, {
                        sender: 'ai',
                        content: aiResponseText,
                        timestamp: Date.now()
                    });
                }
            } catch (error) {
                errorMessage.textContent = '답변을 가져오는 중 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.';
                errorMessage.classList.remove('hidden');
            } finally {
                loadingSpinner.classList.add('hidden');
                submitButton.disabled = false;
                questionInput.disabled = false;
            }
        }

        async function summarizeResponse() {
            if (!lastAiResponse) {
                return;
            }

            loadingSpinner.classList.remove('hidden');
            submitButton.disabled = true;
            questionInput.disabled = true;
            summarizeButton.disabled = true;
            errorMessage.classList.add('hidden');

            const systemInstruction = "다음 텍스트를 핵심만 요약하여 한국어로 3문장 이내로 정리해 주세요.";
            
            try {
                const summaryText = await getApiResponse(lastAiResponse, systemInstruction);
                if (summaryText) {
                    addMessageToUI(summaryText, 'ai', true);
                }
            } catch (error) {
                errorMessage.textContent = '요약본을 생성하는 중 오류가 발생했습니다.';
                errorMessage.classList.remove('hidden');
            } finally {
                loadingSpinner.classList.add('hidden');
                submitButton.disabled = false;
                questionInput.disabled = false;
                summarizeButton.disabled = false;
            }
        }
        
        // Event listeners
        if (saveKeyButton) {
            saveKeyButton.addEventListener('click', async () => {
                const key = apiKeyInput.value.trim();
                if (key) {
                    const isSaved = await saveApiKey(key);
                    if (isSaved) {
                        OPENAI_API_KEY = key;
                        hideModal();
                        addMessageToUI("API 키가 저장되었습니다. 무엇을 도와드릴까요?", 'ai');
                    } else {
                        document.getElementById('modal-error-message').textContent = '키를 저장하는 중 오류가 발생했습니다. 다시 시도해 주세요.';
                        document.getElementById('modal-error-message').classList.remove('hidden');
                    }
                } else {
                    document.getElementById('modal-error-message').textContent = '유효한 API 키를 입력해 주세요.';
                    document.getElementById('modal-error-message').classList.remove('hidden');
                }
            });
        }
        
        if (submitButton) {
             submitButton.addEventListener('click', sendMessage);
        }
       
        if (summarizeButton) {
             summarizeButton.addEventListener('click', summarizeResponse);
        }
       
        if (questionInput) {
            questionInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            });
        }
        
        // This is necessary for a file to run correctly on Canvas. Do not modify.
        if (typeof __app_id !== 'undefined' && typeof __firebase_config !== 'undefined') {
            console.log("Canvas environment detected. Initializing with provided config.");
        } else {
            console.error("Canvas environment variables (__app_id, __firebase_config) are not defined. The app may not function correctly.");
        }
    </script>
</body>
</html>
