<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 학습 도구</title>
    <!-- Tailwind CSS CDN을 사용하여 스타일링 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px; /* 모바일 화면에 맞춰 패딩 조정 */
        }
        .message-container {
            word-wrap: break-word;
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="bg-gray-100 p-2 sm:p-6">
    <div class="container mx-auto max-w-2xl bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col min-h-[95vh] w-full">
        <!-- 헤더 섹션 -->
        <header class="bg-blue-600 text-white p-4 sm:p-6 rounded-t-2xl">
            <h1 class="text-2xl sm:text-3xl font-bold">AI 학습 도우미</h1>
            <p class="text-blue-200 mt-1 text-sm sm:text-base">탐구활동에 필요한 질문을 입력하면 AI가 답변해 드립니다.4o-mini</p>
        </header>

        <!-- 대화 영역 -->
        <div id="chat-container" class="flex-grow p-4 sm:p-6 overflow-y-auto space-y-4">
            <!-- 초기 환영 메시지 -->
            <div class="flex justify-start">
                <div class="bg-gray-200 text-gray-800 p-3 rounded-xl max-w-[85%]">
                    <p>안녕하세요! 무엇을 도와드릴까요? (예: '유사과학이란 무엇인가요?')</p>
                </div>
            </div>
        </div>

        <!-- 입력 섹션 -->
        <div class="p-4 sm:p-6 border-t border-gray-200">
            <div class="flex items-end space-x-2 sm:space-x-3">
                <textarea id="question-input" rows="1" class="flex-grow resize-none rounded-xl border border-gray-300 p-3 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="여기에 질문을 입력하세요..."></textarea>
                <button id="submit-button" class="bg-blue-600 text-white p-3 rounded-xl shadow-md hover:bg-blue-700 transition-colors duration-200 whitespace-nowrap">
                    보내기
                </button>
            </div>
            <!-- 로딩 및 오류 메시지 -->
            <div id="status-message" class="mt-2 text-center text-sm hidden">
                <p id="loading-spinner" class="text-blue-500 flex items-center justify-center hidden">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    답변 생성 중...
                </p>
                <p id="error-message" class="text-red-500 hidden"></p>
            </div>
            <button id="summarize-button" class="mt-4 w-full bg-blue-500 text-white p-3 rounded-xl shadow-md hover:bg-blue-600 transition-colors duration-200 flex items-center justify-center space-x-2 hidden">
                ✨ 마지막 답변 요약하기
            </button>
        </div>
    </div>

    <script>
        // DOM 요소 가져오기
        const chatContainer = document.getElementById('chat-container');
        const questionInput = document.getElementById('question-input');
        const submitButton = document.getElementById('submit-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessage = document.getElementById('error-message');
        const summarizeButton = document.getElementById('summarize-button');

        // 모델 선택 및 API 설정
        // IMPORTANT: OpenAI 모델만 사용하도록 설정
        const currentApi = 'openai';

        // API 설정 객체: 모델별 API 키와 URL을 여기에 정의
        const apiConfigs = {
            openai: {
                apiKey: "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", // 여기에 OpenAI API 키를 입력하세요
                model: "gpt-4o-mini", // GPT-4o-mini 모델 사용
                textUrl: "https://api.openai.com/v1/chat/completions"
            }
        };

        let lastAiResponse = ""; // 마지막 AI 답변을 저장할 변수

        // 메시지를 채팅 컨테이너에 추가하는 함수
        function addMessage(content, sender, isSummary = false, isImage = false) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('flex');
            
            if (sender === 'user') {
                messageElement.classList.add('justify-end');
                messageElement.innerHTML = `
                    <div class="bg-blue-500 text-white p-3 rounded-xl max-w-[85%] message-container">
                        <p>${content}</p>
                    </div>
                `;
            } else { // sender === 'ai'
                messageElement.classList.add('justify-start');
                if (isImage) {
                    messageElement.innerHTML = `
                        <div class="bg-gray-200 text-gray-800 p-3 rounded-xl max-w-[85%] message-container">
                            <img src="data:image/png;base64,${content}" alt="AI generated image" class="rounded-xl w-full h-auto">
                        </div>
                    `;
                } else {
                    messageElement.innerHTML = `
                        <div class="bg-gray-200 text-gray-800 p-3 rounded-xl max-w-[85%] message-container">
                            <p>${content}</p>
                        </div>
                    `;
                }
            }
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            if (sender === 'ai' && !isSummary && !isImage) {
                lastAiResponse = content;
                summarizeButton.classList.remove('hidden');
            } else {
                summarizeButton.classList.add('hidden');
            }
        }

        // OpenAI API로 답변을 받는 함수
        async function getApiResponse(prompt, systemInstruction = null) {
            const config = apiConfigs[currentApi];
            let retryCount = 0;
            const maxRetries = 3;
            const baseDelay = 1000;

            while (retryCount < maxRetries) {
                try {
                    let messages = [{ role: "user", content: prompt }];
                    if (systemInstruction) {
                        messages.unshift({ role: "system", content: systemInstruction });
                    }

                    const payload = {
                        model: config.model,
                        messages: messages
                    };
                    
                    const response = await fetch(config.textUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${config.apiKey}`
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        let errorDetail = `Status: ${response.status} ${response.statusText}`;
                        if (response.status === 401) {
                            errorDetail = 'API 키가 유효하지 않습니다. 코드에 API 키를 올바르게 입력했는지 확인해 주세요.';
                        } else if (response.status === 403) {
                             errorDetail = 'API 키에 이 모델에 접근할 수 있는 권한이 없습니다.';
                        } else if (response.status === 429) {
                            const delay = baseDelay * Math.pow(2, retryCount);
                            console.log(`Rate limit exceeded. Retrying in ${delay}ms...`);
                            await new Promise(res => setTimeout(res, delay));
                            retryCount++;
                            continue;
                        }
                        const errorResponseText = await response.text();
                        console.error("API error response:", errorResponseText);
                        throw new Error(`API error: ${errorDetail}`);
                    }

                    const result = await response.json();
                    const text = result?.choices?.[0]?.message?.content;
                    
                    if (text) {
                        return text;
                    } else {
                        throw new Error("API response did not contain expected text.");
                    }
                } catch (error) {
                    console.error("Failed to fetch from API:", error);
                    throw error;
                }
            }
            throw new Error("Failed to fetch from API after multiple retries.");
        }

        // AI 에이전트에 질문을 보내는 함수
        async function sendMessage() {
            const question = questionInput.value.trim();
            if (question === '') {
                return;
            }

            addMessage(question, 'user');
            questionInput.value = '';
            
            // 로딩 스피너 표시 및 버튼 비활성화
            loadingSpinner.classList.remove('hidden');
            submitButton.disabled = true;
            questionInput.disabled = true;
            summarizeButton.classList.add('hidden');
            errorMessage.classList.add('hidden');

            try {
                const aiResponseText = await getApiResponse(question);
                addMessage(aiResponseText, 'ai');
            } catch (error) {
                errorMessage.textContent = '답변을 가져오는 중 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.';
                errorMessage.classList.remove('hidden');
            } finally {
                loadingSpinner.classList.add('hidden');
                submitButton.disabled = false;
                questionInput.disabled = false;
            }
        }

        // 마지막 AI 답변을 요약하는 함수
        async function summarizeResponse() {
            if (!lastAiResponse) {
                return;
            }

            // 로딩 스피너 표시 및 버튼 비활성화
            loadingSpinner.classList.remove('hidden');
            submitButton.disabled = true;
            questionInput.disabled = true;
            summarizeButton.disabled = true;
            errorMessage.classList.add('hidden');

            const systemInstruction = "다음 텍스트를 핵심만 요약하여 한국어로 3문장 이내로 정리해 주세요.";
            
            try {
                const summaryText = await getApiResponse(lastAiResponse, systemInstruction);
                addMessage(summaryText, 'ai', true);
            } catch (error) {
                errorMessage.textContent = '요약본을 생성하는 중 오류가 발생했습니다.';
                errorMessage.classList.remove('hidden');
            } finally {
                loadingSpinner.classList.add('hidden');
                submitButton.disabled = false;
                questionInput.disabled = false;
                summarizeButton.disabled = false;
            }
        }

        // '보내기' 버튼 클릭 이벤트 리스너
        submitButton.addEventListener('click', sendMessage);

        // '요약하기' 버튼 클릭 이벤트 리스너
        summarizeButton.addEventListener('click', summarizeResponse);

        // 'Enter' 키 누를 때 메시지 보내기
        questionInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); // 새 줄이 추가되는 것을 방지
                sendMessage();
            }
        });
    </script>
</body>
</html>
